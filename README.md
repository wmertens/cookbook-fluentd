# Fluentd server and client

This cookbook contains setup for [fluentd](http://fluentd.org/) server and fluentd client.  
This cookbook is designed to work with [Technicolor fork of ironfan](https://github.com/virdata/ironfan).

## Cookbooks

* server
* client
* file_monitor

## Server

Installs and starts fluentd server.

### Server configuration options

* `node[:fluentd][:server][:port]`: port used by the `forward` source
* `node[:fluentd][:server][:log_dir]`: direcotry where the logs should go to
* `node[:fluentd][:server][:enable_hdfs_output]`: makes webhdfs output available
* `node[:fluentd][:server][:enable_mongo_output]`: makes MongoDB output available
* `node[:fluentd][:server][:enable_s3_output]`: makes S3 output available
* `node[:fluentd][:server][:matches]`: hash of the default matches for the server
* `node[:fluentd][:server][:sources]`: array of sources

### Adding your own matches:

    node[:fluentd][:server][:matches].merge!({ "name.of.the.match.**" => {
	  :type => "file",
	  :file => "/path/to/a/file"
    }})

Each key of a top hash becomes a `<match ...>` section. Each nested hash' key becomes a property and the value is used as a value.

### Adding your own sources:

    node[:fluentd][:server][:sources] << {
	  :type => "http",
	  :port => 8888
    }

## Client

Installs dependencies required to run fluentd client.

### Client configuration options

* `node[:fluentd][:client][:working_dir]`: direcotry in which all the client files will be installed and run from
* `node[:fluentd][:client][:matches]`: same as in case of the server, this allows you to specify placement of the files generated by a given client / set of clients
* `node[:fluentd][:client][:log_on_term]`: string, message to log when a given logger is asked to terminate, default `nil`
* `node[:fluentd][:client][:options]`: additional options for `tail -f` command, default `-n 0`
* `node[:fluentd][:client][:jobs]`: array of jobs, one file per job

### Specifying jobs

In `cluster_overrides` do the following:

    :fluentd => {
      :client => {
        :matches => {
          "syslogs.**" => { :type => "file", :path => "$data/syslogs" },
          ...
        },
        :jobs => [
          { :file => "/var/log/syslog", :name => "syslog", :category => "syslogs.$name" },
          ...
        ]
      }
    }

The above code is going to observe `/var/log/syslog` and forward all entries to a fluentd server. Category name points to a file on the fluentd server where all the entries can be found.  

`$data` will be replaced with `node[:fluentd][:server][:log_dir]`.  
`$name` will be replaced with `#{cluster_name}-#{facet_name}-#{facet_index}`.

## License

- Author: Radek Gruchalski (<radek@gruchalski.com>)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
